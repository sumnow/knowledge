# CAP 定理

## 定义

CAP定理: 指在一个分布式系统中, Consistency(一致性), Availability(可用性), Partitioin tolerance(分区容错性), 最多只能同时满足两个.

### Consistency (一致性):

"all nodes see the same data at the same time", 即更新操作成功并返回客户端后, 所有节点在同一时间的数据完全一致, 这就是分布式的一致性。 一致性的问题在并发系统中不可避免, 对于客户端来说, 一致性指的是并发访问时更新过的数据如何获取的问题。 从服务端来看, 则是更新如何复制分布到整个系统, 以保证数据最终一致。 

### Availability (可用性):

可用性指"Reads and writes always succeed", 即服务一直可用, 而且是正常响应时间。 好的可用性主要是指系统能够很好的为用户服务, 不出现用户操作失败或者访问超时等用户体验不好的情况。 

### Partition Tolerance (分区容错性):

即分布式系统在遇到某节点或网络分区故障的时候, 仍然能够对外提供满足一致性和可用性的服务。 

分区容错性要求能够使应用虽然是一个分布式系统, 而看上去却好像是在一个可以运转正常的整体。 比如现在的分布式系统中有某一个或者几个机器宕掉了, 其他剩下的机器还能够正常运转满足系统需求, 对于用户而言并没有什么体验上的影响。 

### 为什么只能三选二

例如, 服务器A, 存有库存100件, 服务器B, 与A同步, 如果A与B的链接断开了, 那么如果A, 变成了库存90件, 访问B的用户看见的, 依然是库存100件, 有两个方法解决问题, 第一是, 否决一致性, 把100件返回给用户, 第二是, 否决可用性, 将系统阻塞, 直到恢复正常.

## 取舍策略

CAP三个特性只能满足其中两个, 那么取舍的策略就共有三种:

### CA without P:

如果不要求P(不允许分区), 则C(强一致性)和A(可用性)是可以保证的。 但放弃P的同时也就意味着放弃了系统的扩展性, 也就是分布式节点受限, 没办法部署子节点, 这是违背分布式系统设计的初衷的。 

### CP without A:

如果不要求A(可用), 相当于每个请求都需要在服务器之间保持强一致, 而P(分区)会导致同步时间无限延长(也就是等待数据同步完才能正常访问服务), 一旦发生网络故障或者消息丢失等情况, 就要牺牲用户的体验, 等待所有数据全部一致了之后再让用户访问系统。 设计成CP的系统其实不少, 最典型的就是分布式数据库, 如Redis、 HBase等。 对于这些分布式数据库来说, 数据的一致性是最基本的要求, 因为如果连这个标准都达不到, 那么直接采用关系型数据库就好, 没必要再浪费资源来部署分布式数据库。 

### AP without C

要高可用并允许分区, 则需放弃一致性。 一旦分区发生, 节点之间可能会失去联系, 为了高可用, 每个节点只能用本地数据提供服务, 而这样会导致全局数据的不一致性。 典型的应用就如某米的抢购手机场景, 可能前几秒你浏览商品的时候页面提示是有库存的, 当你选择完商品准备下单的时候, 系统提示你下单失败, 商品已售完。 这其实就是先在 A(可用性)方面保证系统可以正常的服务, 然后在数据的一致性方面做了些牺牲, 虽然多少会影响一些用户体验, 但也不至于造成用户购物流程的严重阻塞。 

现如今, 对于多数大型互联网应用的场景, 主机众多、 部署分散, 而且现在的集群规模越来越大, 节点只会越来越多, 所以节点故障、 网络故障是常态, 因此分区容错性也就成为了一个分布式系统必然要面对的问题。 那么就只能在C和A之间进行取舍。 但对于传统的项目就可能有所不同, 拿银行的转账系统来说, 涉及到金钱的对于数据一致性不能做出一丝的让步, C必须保证, 出现网络故障的话, 宁可停止服务, 可以在A和P之间做取舍。 

总而言之, 没有最好的策略, 好的系统应该是根据业务场景来进行架构设计的, 只有适合的才是最好的。 

### 后记

说到怎么保持两个服务的数据一致性:

1. 如果是在同一个服务器里, 链接同一个数据库, 那么使用数据库事务就可以同步; 

2. 如果是不同的服务器里, 链接不同数据库, 那么也有两种方式; 

    - 如果接口请求失败了, 调用备用接口, 执行回滚操作, 这种方式的坏处在于每个都要写一个备用接口, 且阻塞进程.

    - 如果接口请求失败了, 将接口服务放到一个队列里, 不断循环执行, 当队列空了以后, 数据就同步了, 因此这种方案的数据实时一致性很差.

