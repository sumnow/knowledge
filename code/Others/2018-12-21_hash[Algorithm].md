# hash 在密码里的应用

之前说过一些关于hash在数据结构中的应用, 例如, 建立hash表, 解决hash碰撞的结构等等

在[这里](2018-10-22_hash[Algorithm].md)查看

这次说一说hash在密码里的应用

首先考虑这几个问题(不用考虑https在其中的影响):

// https 已经完善地解决了中间人拦截, 重放登录请求等

1. 先考虑一下在上网的时候, 你进行登录操作的时候, 中间发生了什么.

2. 为什么现在没有找回密码的功能, 而是重设密码?

那么, 先来说一说密码存储在数据库的方式:

1. 明文

这是一种非常非常不安全的方式, 扒了数据库就跑

2. 浏览器加密

这种加密其实形同虚设, 因为考虑到hacker可能拿到源代码, 到时候服务器的加密就形同虚设.

3. md5值校验

即, 对用户输入的密码做md5提取, 再将值传到服务器上进行对比(服务器为了安全也不会保存明文密码, 而是使用md5), 其实这种方式一旦有人拦截, 那么无需明文密码就可以使用md5串冒充登录了.而且md5算法并不复杂, 用彩虹表法可以比较快地查找到明文. 所以无论前端是否加密, 在服务端都应该进行更完善的加密操作(甚至有些浏览器禁用了js脚本), 用以提高效率.

> 有种情况就是在用户输入完密码以后, 发现密码框里的字符一下变得很多, 这个大概率就是做了md5提取.

4. 哈希加盐

盐就是加在密码后面的一段随机字符串, 加上这段字符串之后再进行哈希这一段字符串使可以公开的, (作用与非对称加密中的公钥类似), 但是必须足够复杂, 而且对于每个用户来说不能够重复, 以防范相同密码进行的撞库等攻击.加盐后也使得彩虹表失效

应当注意的是, 用来保护密码的哈希函数, 和数据结构课学到的哈希函数是不同的。 例如, 实现哈希表的哈希函数设计目的是快速查找, 而非安全性。 只有加密哈希函数( cryptographic hash function)才可以用来进行密码哈希加密。 像 SHA256 、 SHA512 、 RIPEMD 和 WHIRLPOOL 都是加密哈希函数。 

这里补充一种基于 HMAC(Hash-based Message Authentication Code)的加密方式

用户登录时, 并不会将原文发送到服务器。 而是由服务器发送一小段随机的数据过来, 然后客户端基于这段随机的数据以及用户输入的密码, 通过约定好的哈希算法生成一段摘要值。 客户端把生成好的摘要发送到服务端, 由于服务端只收到摘要, 因此并不知道用户输入的密码是什么, 为了够判断用户密码是否正确, 它需要自己也做一次计算, 把随机数据以及数据库中存储的用户密码的哈希值都取出来, 也做一次哈希运算, 然后将自己计算出的摘要与客户端发来的摘要进行比对, 如果一致, 则通过。 整个过程也没有明文发送给服务端, 所以服务端还是无法知道用户的明文密码。 这种方案没有涉及 HTTPS, 因此它是免费的。 并且, 客户端每次发给服务端用于验证的哈希值都不同。 这一点很重要, 即使遭到黑客窃听, 黑客也无法通过重放攻击伪造用户身份登录。 (如果要进一步阻断中间人攻击, 这种方案还需扩展)

这里还有一个关于HMAC加密的过程

HMAC 加密:

注册: 
1.0在注册时获取随机字符串 KEY
1.1 服务器保存 KEY
1.2 客户端保存 KEY

2.0客户端用 KEY将密码进行HMAC 加密
2.1将加密后的密码发送给服务器
2.2服务器保存密码
2.3完成注册

登录: 
1.0获取本地的密钥 KEY
1.1如果不存在 KEY 说明是换了手机或者咋的 启动获取 KEY 的流程 或者启动验证设备锁
1.2存在 KEY, 用 KEY 对密码进行 HMAC加密
1.3发送加密后的密码 给服务器

2.0服务器判断密码是否匹配

登录保密 plus: 
1.0获取本地的密钥 KEY
1.1如果不存在 KEY 说明是换了手机或者咋的 启动获取 KEY 的流程 或者启动验证设备锁
1.2存在 KEY, 用 KEY 对密码HMAC加密
1.3对HMAC加密后的密码 拼接时间戳字符串(到分钟)
1.4用 MD5对拼接后的字符串加密
1.5发生加密后的密码给服务器

2.0服务器取到保存的密码
2.1把密码拼接时间戳(分钟) str1
2.2再拼接一个下一分钟的时间戳 str2
2.2对两个字符串 MD5加密
2.3把两个字符串与客户端发来的字符串对比 只要有一个匹配 则登录成功

5. 慢加密

我们知道MD5, SHA的算法速度太快了。 所以, 我们需要一个"慢一点"的加密算法。 呵呵。 bcrypt是这样的一个算法, 因为它很慢, 对于计算机来说, 其慢得有点BT了, 但却慢得刚刚好!对于验证用户口令来说是不慢的, 对于穷举用户口令来说, 其会让那些计算机变得如同蜗牛一样。 

因为bcrypt采用了一系列各种不同的Blowfish加密算法, 并引入了一个work factor, 这个工作因子可以让你决定这个算法的代价有多大。 因为这些, 这个算法不会因为计算机CPU处理速度变快了, 而导致算法的时间会缩短了。 因为, 你可以增加work factor来把其性能降下来。 呵呵。 

那么, bcrypt到底有多慢？ 如果和MD5一起来比较的话, 如果使用值为12的work factor的话, 如果加密"cool"的话, bcrypt需要0.3秒, 而MD5只需要一微秒(百万分之一秒)。 也就是说, 前面我们说的那个只需要40秒就可以穷举完所有的可能的MD5编码的口令的算法, 在使用bcrypt下, 需要12年。 

#### 破解的手段

如, 暴力破解, 查表法, 彩虹表法.

#### 使用https, get请求的url是否被加密

是的，HTTPS对URL加密了。SSL连接建立在TCP层和HTTP层之间。客户端和服务器首先建立一个安全的加密的TCP连接(通过SSL/TLS协议)，然后客户端将通过该加密的TCP连接发送HTTP请求(GET，POST，DELETE ...)。

由于请求URL是一个HTTP事物(OSI第7层)，因此URL的其余部分(/path/?some=parameters&go=here)在ClientHello中看不到，因此它永远不会在TLS握手(第4层或第5层)中显示。

--- 

[这里](https://www.zhihu.com/question/25539382)有一些关于加密在前端的实践讨论可以关注一下.

